<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - LearnNest</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="Dashboard-Home.css">
  <style>
        .avatar-preview {
      width: 120px;
      height: 120px;
      object-fit: cover;
    }

    .avatar-glow {
      box-shadow: 0 0 10px rgba(0, 170, 255, 0.6);
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #198754;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .profile-stats .card {
      transition: transform 0.3s ease;
    }
    
    .profile-stats .card:hover {
      transform: translateY(-5px);
    }
    
    #profileBio {
      background-color: rgba(0, 191, 255, 0.1);
      border-left: 3px solid deepskyblue;
      padding: 10px;
      border-radius: 0 5px 5px 0;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>   
</head>
<body>
  <iframe src="ultra-loader.html" style="border:0;position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;" frameborder="0"></iframe>

  <button class="sidebar-toggle-btn" onclick="toggleSidebar()">☰</button>
  <div class="sidebar" id="sidebar">
    <h2>LearnNest by Technify</h2>
    <a href="Dashboard-Home.html"><i class="fas fa-chart-line"></i> Dashboard</a>
    <a href="My-Courses.html"><i class="fas fa-book"></i> My Courses</a>
    <a href="Create-Course.html"><i class="fa-solid fa-square-plus"></i> Create Course</a>
    <a href="Students.html"><i class="fas fa-user-graduate"></i> Students</a>
    <a href="Earnings.html"><i class="fas fa-wallet"></i> Earnings</a>
    <a href="Profile.html" class="active"><i class="fas fa-user"></i> Profile</a>
    <a href="Settings.html"><i class="fas fa-cog"></i> Settings</a>
  </div>
  <div id="sidebar-placeholder"></div>

  <div class="main">
    <div class="main-content p-4">
      <div class="container-fluid">
        <!-- Loading State -->
        <div id="profileLoader" class="text-center py-5">
          <div class="loader"></div>
          <p class="mt-3">Loading profile...</p>
        </div>

        <!-- Error State -->
        <div id="profileError" class="alert alert-danger d-none" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span id="errorMessage">Failed to load profile</span>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" class="d-none">
          <!-- Main Profile Card -->
          <div class="card card-custom mb-4">
            <div class="card-title mb-3 d-flex justify-content-between align-items-center">
              <h4 class="mb-0">My Profile</h4>
              <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="fas fa-edit me-1"></i> Edit Profile
              </button>
            </div>
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-3 text-center">
                  <img id="profileAvatar" src="assets/img/user-default.png" class="rounded-circle border avatar-preview avatar-glow" alt="Profile Image" />
                  <div class="mt-3">
                    <label for="avatarUpload" class="btn btn-sm btn-outline-info w-100">
                      <i class="fas fa-camera me-1"></i> Change Photo
                    </label>
                    <input type="file" class="d-none" id="avatarUpload" accept="image/*">
                  </div>
                </div>
                <div class="col-md-9">
                  <h3 class="mb-2 text-info" id="profileName">Loading...</h3>
                  <p class="mb-2"><i class="fas fa-envelope me-2 text-muted"></i> <span id="profileEmail">Loading...</span></p>
                  <p class="mb-2"><i class="fas fa-user-tag me-2 text-muted"></i> Role: Instructor</p>
                  <p class="mb-2"><i class="fas fa-calendar-alt me-2 text-muted"></i> <span id="profileJoined">Loading...</span></p>
                  <div class="mt-3">
                    <span class="badge bg-info me-2"><i class="fas fa-book me-1"></i> Courses: <span id="badgeCourses">0</span></span>
                    <span class="badge bg-success me-2"><i class="fas fa-users me-1"></i> Students: <span id="badgeStudents">0</span></span>
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-12">
                  <div id="profileBio">Loading bio...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Cards -->
          <div class="row profile-stats mb-4">
            <div class="col-md-4">
              <div class="card card-custom text-center p-3">
                <h4 class="text-info" id="statCourses">0</h4>
                <p class="text-muted mb-0">Courses Created</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-custom text-center p-3">
                <h4 class="text-info" id="statStudents">0</h4>
                <p class="text-muted mb-0">Students Enrolled</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-custom text-center p-3">
                <h4 class="text-info" id="statEarnings">$520</h4>
                <p class="text-muted mb-0">Earnings This Month</p>
              </div>
            </div>
          </div>

          <!-- Additional Profile Info -->
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card card-custom h-100">
                <div class="card-body">
                  <h5 class="card-title text-info"><i class="fas fa-id-card me-2"></i> Contact Info</h5>
                  <div class="mb-3">
                    <p class="mb-1"><strong><i class="fas fa-phone me-2"></i> Phone:</strong> <span id="contactPhone">Loading...</span></p>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editContact('phone')">Edit</button>
                  </div>
                  <div>
                    <p class="mb-1"><strong><i class="fas fa-map-marker-alt me-2"></i> Location:</strong> <span id="contactLocation">Loading...</span></p>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editContact('location')">Edit</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 mb-4">
              <div class="card card-custom h-100">
                <div class="card-body">
                  <h5 class="card-title text-info"><i class="fas fa-share-alt me-2"></i> Social Profiles</h5>
                  <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                      <strong><i class="fab fa-linkedin me-2"></i> LinkedIn:</strong> 
                      <a id="socialLinkedIn" href="#" class="text-decoration-none">Loading...</a>
                      <button class="btn btn-sm btn-outline-secondary ms-2" onclick="editSocial('linkedin')">Edit</button>
                    </li>
                    <li class="mb-2">
                      <strong><i class="fab fa-github me-2"></i> GitHub:</strong> 
                      <a id="socialGitHub" href="#" class="text-decoration-none">Loading...</a>
                      <button class="btn btn-sm btn-outline-secondary ms-2" onclick="editSocial('github')">Edit</button>
                    </li>
                    <li>
                      <strong><i class="fas fa-globe me-2"></i> Website:</strong> 
                      <a id="socialWebsite" href="#" class="text-decoration-none">Loading...</a>
                      <button class="btn btn-sm btn-outline-secondary ms-2" onclick="editSocial('website')">Edit</button>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content card-custom">
          <div class="modal-header">
            <h5 class="modal-title text-info" id="editProfileModalLabel">Update Profile Info</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="profileForm">
            <div class="modal-body">
              <div class="mb-3">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" class="form-control bg-dark text-light" id="fullName" name="name" required />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control bg-dark text-light" id="email" name="email" required />
              </div>
              <div class="mb-3">
                <label for="bio" class="form-label">Bio</label>
                <textarea class="form-control bg-dark text-light" id="bio" name="bio" rows="3"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-info" id="saveProfileBtn">
                <span class="btn-text">Save Changes</span>
                <span class="btn-loader d-none"><div class="loader"></div></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Contact Modal -->
    <div class="modal fade" id="editContactModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content card-custom">
          <div class="modal-header">
            <h5 class="modal-title text-info" id="editContactModalLabel">Update Contact Info</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="contactForm">
            <div class="modal-body">
              <div class="mb-3">
                <label for="contactType" class="form-label">Field</label>
                <input type="text" class="form-control bg-dark text-light" id="contactType" readonly>
              </div>
              <div class="mb-3">
                <label for="contactValue" class="form-label">Value</label>
                <input type="text" class="form-control bg-dark text-light" id="contactValue" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-info" id="saveContactBtn">
                <span class="btn-text">Update</span>
                <span class="btn-loader d-none"><div class="loader"></div></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Social Modal -->
    <div class="modal fade" id="editSocialModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content card-custom">
          <div class="modal-header">
            <h5 class="modal-title text-info" id="editSocialModalLabel">Update Social Profile</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="socialForm">
            <div class="modal-body">
              <div class="mb-3">
                <label for="socialType" class="form-label">Platform</label>
                <input type="text" class="form-control bg-dark text-light" id="socialType" readonly>
              </div>
              <div class="mb-3">
                <label for="socialUrl" class="form-label">Profile URL</label>
                <input type="url" class="form-control bg-dark text-light" id="socialUrl" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-info" id="saveSocialBtn">
                <span class="btn-text">Update</span>
                <span class="btn-loader d-none"><div class="loader"></div></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="successToast" class="toast">✅ Profile Updated Successfully!</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/jquery.min.js"></script>
  <script>
    // Profile Page JavaScript
    const API_BASE_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
      ? "http://localhost/learnnest-backend/api/"
      : "/learnnest-backend/api/";

    let currentUser = null;
    let currentContactField = null;
    let currentSocialField = null;

    // DOM Elements
    const profileLoader = document.getElementById('profileLoader');
    const profileError = document.getElementById('profileError');
    const profileContent = document.getElementById('profileContent');
    const successToast = document.getElementById('successToast');

    // Load profile data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadProfile();
    });

    // Load profile function
    async function loadProfile() {
      try {
        showLoader(true);
        const response = await fetch(`${API_BASE_URL}get-profile.php`);
        const data = await response.json();

        if (data.success) {
          currentUser = data.data;
          populateProfile(currentUser);
          showContent(true);
        } else {
          showError(data.message || 'Failed to load profile');
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showError('Network error occurred');
      }
    }

    // Populate profile with data
    function populateProfile(user) {
      // Main profile info
      document.getElementById('profileName').textContent = user.name || 'N/A';
      document.getElementById('profileEmail').textContent = user.email || 'N/A';
      document.getElementById('profileBio').textContent = user.bio || 'No bio added yet.';
      document.getElementById('profileJoined').textContent = user.updated_at ? `Updated: ${new Date(user.updated_at).toLocaleDateString()}` : 'Recently joined';
      
      // Avatar
      const avatar = document.getElementById('profileAvatar');
      if (user.avatar) {
        avatar.src = user.avatar.startsWith('http') ? user.avatar : `${user.avatar}`;
      }

      // Stats
      document.getElementById('statCourses').textContent = user.courses_created || 0;
      document.getElementById('statStudents').textContent = user.students_enrolled || 0;
      document.getElementById('badgeCourses').textContent = user.courses_created || 0;
      document.getElementById('badgeStudents').textContent = user.students_enrolled || 0;

      // Contact info
      document.getElementById('contactPhone').textContent = user.contact_number || 'Not provided';
      document.getElementById('contactLocation').textContent = user.location || 'Not provided';

      // Social links
      updateSocialLink('socialLinkedIn', user.linkedin);
      updateSocialLink('socialGitHub', user.github);
      updateSocialLink('socialWebsite', user.website);

      // Populate form fields
      document.getElementById('fullName').value = user.name || '';
      document.getElementById('email').value = user.email || '';
      document.getElementById('bio').value = user.bio || '';
    }

    // Update social link display
    function updateSocialLink(elementId, url) {
      const element = document.getElementById(elementId);
      if (url) {
        element.textContent = url;
        element.href = url.startsWith('http') ? url : `https://${url}`;
      } else {
        element.textContent = 'Not provided';
        element.href = '#';
      }
    }

    // Show/hide loading states
    function showLoader(show) {
      profileLoader.style.display = show ? 'block' : 'none';
      profileError.classList.add('d-none');
      profileContent.classList.add('d-none');
    }

    function showError(message) {
      profileLoader.style.display = 'none';
      profileContent.classList.add('d-none');
      profileError.classList.remove('d-none');
      document.getElementById('errorMessage').textContent = message;
    }

    function showContent(show) {
      profileLoader.style.display = 'none';
      profileError.classList.add('d-none');
      if (show) {
        profileContent.classList.remove('d-none');
      }
    }

    // Show success toast
    function showToast(message = '✅ Profile Updated Successfully!') {
      successToast.textContent = message;
      successToast.classList.add('show');
      setTimeout(() => {
        successToast.classList.remove('show');
      }, 3000);
    }

    // Avatar upload handling
    document.getElementById('avatarUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Preview the image
        const reader = new FileReader();
        reader.onload = function(event) {
          document.getElementById('profileAvatar').src = event.target.result;
        };
        reader.readAsDataURL(file);

        // Upload the avatar
        uploadAvatar(file);
      }
    });

    // Upload avatar function
    async function uploadAvatar(file) {
      try {
        const formData = new FormData();
        formData.append('avatar', file);

        const response = await fetch(`${API_BASE_URL}upload-avatar.php`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          showToast('✅ Avatar updated successfully!');
          loadProfile(); // Reload to get updated data
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error uploading avatar:', error);
        showToast('❌ Failed to upload avatar');
        // Revert the preview
        if (currentUser && currentUser.avatar) {
          document.getElementById('profileAvatar').src = currentUser.avatar;
        }
      }
    }

    // Profile form submission
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('saveProfileBtn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoader = submitBtn.querySelector('.btn-loader');
      
      try {
        // Show loading state
        btnText.classList.add('d-none');
        btnLoader.classList.remove('d-none');
        submitBtn.disabled = true;

        const formData = new FormData(this);
        const response = await fetch(`${API_BASE_URL}update-profile.php`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          showToast('✅ Profile updated successfully!');
          bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
          loadProfile(); // Reload profile data
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        showToast('❌ Failed to update profile');
      } finally {
        // Reset button state
        btnText.classList.remove('d-none');
        btnLoader.classList.add('d-none');
        submitBtn.disabled = false;
      }
    });

    // Edit contact function
    function editContact(field) {
      currentContactField = field;
      const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
      
      document.getElementById('contactType').value = field.charAt(0).toUpperCase() + field.slice(1);
      
      if (field === 'phone') {
        document.getElementById('contactValue').value = currentUser.contact_number || '';
      } else if (field === 'location') {
        document.getElementById('contactValue').value = currentUser.location || '';
      }
      
      modal.show();
    }

    // Contact form submission
    document.getElementById('contactForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('saveContactBtn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoader = submitBtn.querySelector('.btn-loader');
      
      try {
        btnText.classList.add('d-none');
        btnLoader.classList.remove('d-none');
        submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('field', currentContactField);
        formData.append('value', document.getElementById('contactValue').value);

        const response = await fetch(`${API_BASE_URL}update-contact.php`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          showToast('✅ Contact info updated!');
          bootstrap.Modal.getInstance(document.getElementById('editContactModal')).hide();
          loadProfile();
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error updating contact:', error);
        showToast('❌ Failed to update contact info');
      } finally {
        btnText.classList.remove('d-none');
        btnLoader.classList.add('d-none');
        submitBtn.disabled = false;
      }
    });

    // Edit social function
    function editSocial(platform) {
      currentSocialField = platform;
      const modal = new bootstrap.Modal(document.getElementById('editSocialModal'));
      
      document.getElementById('socialType').value = platform.charAt(0).toUpperCase() + platform.slice(1);
      document.getElementById('socialUrl').value = currentUser[platform] || '';
      
      modal.show();
    }

    // Social form submission
    document.getElementById('socialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('saveSocialBtn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoader = submitBtn.querySelector('.btn-loader');
      
      try {
        btnText.classList.add('d-none');
        btnLoader.classList.remove('d-none');
        submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('platform', currentSocialField);
        formData.append('url', document.getElementById('socialUrl').value);

        const response = await fetch(`${API_BASE_URL}update-social.php`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          showToast('✅ Social profile updated!');
          bootstrap.Modal.getInstance(document.getElementById('editSocialModal')).hide();
          loadProfile();
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error updating social profile:', error);
        showToast('❌ Failed to update social profile');
      } finally {
        btnText.classList.remove('d-none');
        btnLoader.classList.add('d-none');
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>